> 本书主要作者是 Ralph Kimball，他在数据领域工作超过 30 年，本书主要介绍数仓架构中最广为人知的维度建模方法，并列举了各种业务场景下维度建模方法的经典用法，让读者能够深入理解维度建模的思想。

# 1. 数据仓库、商业智能及维度建模初步

## 1.1 数据仓库与商业智能的目标

DW/BI 系统的基本需求：

- DW/BI 系统要能方便地存取信息
- DW/BI 系统必须以一致的形式展示信息
- DW/BI 系统必须能够适应变化
- DW/BI 系统必须能够及时展现信息
- DW/BI 系统必须成为保护信息财富的安全堡垒
- DW/BI 系统必须成为提高决策制定能力的权威和可信的基础
- DW/BI 系统成功的标志是业务群体接受 DW/BI 系统

最后两项至关重要。

以出版发行工作为例来说明 DW/BI 管理者的职责
杂志的主编需要处理以下活动：

- 理解读者
- 确保杂志对读者具有吸引力
- 维持出版

与之相仿，DW/BI 管理者的职责

- 理解业务用户
- 对业务用户发布高质量、相关的、可访问的信息和分析
- 维持 DW/BI 环境
  上述职责相对于 IT 工作，更趋向于用户和业务过程。

## 1.2 维度建模简介

维度建模主要满足两种需求：

- 以商业用户可理解的方式发布数据
- 提供高效的查询性能
  在关系型数据库系统中实现的维度模型称为星型模型
  ![星型模型](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/41bc8219-f856-40ba-b895-0c437cc38394.png)

有 2 个概念：”事实“和”维度“

- 事实表
  - “事实“这一术语表示某个业务度量。如记录销售的产品的数量单位，以及每种产品在每个销售事务中涉及的销售额，当产品被扫描时可以获取这些度量。业务过程度量事件转换到事实表中。
    ![事实事务](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/78440798-27d4-421d-bb3b-8f575cafc9e5.png)
  - 物理世界的每一个度量事件与对应的事实表行具有一对一的关系，这一思想是维度建模的基本原则。
  - 事实表行数较多，几百万行也是常见。
- 维度表
  - 维度表包含与业务过程度量事件有关的文本环境，它们用于描述与”谁、什么、哪里、何时、如何、为什么“有关的事件。
  - 维度表通常有多列，有 50-100 个属性的维度表并不稀奇。与事实表相比，维度表包含较少的行。
    ![维度表](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/6035b0a9-091a-4cb3-97a7-08e9fe53bc1d.png)
  - 在分析操作性源数据时，如果不清楚一个数值数据元素应该是事实属性还是维度属性，可以通过分析该列是否是一种包含多个值并作为计算的参与者的度量，这种情况下该列往往可能是事实；或者该列是对具体值的描述，是一个常量、某一个约束和行标识的参与者，此时该属性往往是维度属性。如，产品的标价看起来像一个产品的常量属性，但它经常会发生变化，因此它更可能是一种度量事实。
  - 一个数字量到底是事实还是维度属性，一般判断是，连续值数字是事实属性，枚举值不太多的离散数字是维度属性。

维度模型并不要求必须满足第三范式，因为对 BI 查询来说，规范化模型太复杂，用户难以理解、检索，难以记住复杂网络模型，且查询性能也无法保证。维度建模推崇星型模型，不鼓励符合第三范式的雪花模型。
![非规范化维度表](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/f386da5e-123d-48bf-a37e-9658c439c8cb.png)
![维度模型中的事实和维度表](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/380663a6-15ef-4bac-8567-90dc501cb2fb.png)

## 1.3 Kimball 数仓架构

![Kimball数仓架构](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/a29f9de5-456c-4831-b72a-81a4e0dc8c8f.png)

## 1.4 其他 DW/BI 架构

### 1.4.1 独立数据集市架构

在数据集市里使用维度建模方法，但是基于部门构建的，无视了一致性维度和集成。

![独立数据集市架构](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/99cf1f9b-a1ce-499a-b03c-1791e22c7c5c.png)

## 1.4.2 辐射状企业信息工厂 Inmon 架构

![Inmon架构](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/e6b5eeab-c11f-4db7-b37b-39620bd84a57.png)

和维度建模的主要区别在于：

- 符合第 3 范式
- 数据集市是部门级别的
- 包含聚集数据，而不是原子级别细节数据

### 1.4.3 混合辐射状架构与 Kimball 架构

![混合架构](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/b4911033-e64b-4a00-9c2a-abf595553b9b.png)

相比 Kimball 架构，缺点在于：

- 数据需要多次移动，原子细节数据冗余存储
- 需要更多的开销和时间

# 2. Kimball 维度建模技术概述

罗列了一遍术语，读到这一章时不少术语看不懂，略读之，后续又读了两章后渐渐理解了这些术语的含义，故这里跳过本章。

# 3. 零售业务

## 3.1 设计维度模型的 4 个步骤

- 选择业务过程
  - 业务过程是由组织完成的微观活动，例如：获取订单、开具发票、接受付款、处理服务电话、注册学生、执行医疗程序、处理索赔等
- 声明粒度
  - 声明粒度意味着精确定义某个事实表的每一行表示什么。粒度由获取业务过程事件的操作型系统的物理实现确定，如：
    - 客户销售事务上的每个产品扫描到一行中
    - 医生开具的票据的列表内容项采用一行表示
    - 每个银行账户每月的情况采用一行表示
  - 应该以业务术语表示粒度，而不是以现有操作型系统的主键
  - 如果不能清楚地定义粒度，会导致对候选维度的讨论处于兜圈子的状态，不适当的事实将隐藏在设计中
- 确定维度
  - 维度要解决的问题是”业务人员如何描述来自业务过程度量事件的数据？“维度表示的是与”谁、什么、何处、何时、为何、如何“关联的事实
  - 在选择每个维度时，应该列出所有具体的、文本类型的属性以充实每个维度表
  - ”确定维度“即确定事实表中哪些是维度列
- 确定事实
  - 可以通过回答”过程的度量是什么？“这一问题来确定事实。商业用户非常愿意分析这些性能度量（注：本书中的”性能“指的是衡量业务发展的好坏情况）
  - 典型事实是可加数据
  - ”确定事实“即确定事实表中哪些是事实（度量）列

## 3.2 零售业务案例研究

设想，一个大型食品杂货连锁店总部，由 100 个分布于 5 个不同州的分店组成。每个店有完整的部门，包括杂货、冷冻食品、日常生活用品、肉类、农产品、烘烤食品、花卉、保健/美容产品等。每个商店包含被称为产品统一编号（SKU）的 60000 种不同的上架产品。数据存放在商店的几个不同地方。最常用的数据来自 POS 机。
对零售商店来说，管理方面主要关注对订单、库存、销售产品的组织工作，目的是实现利润最大化。管理决策主要与价格和促销有关。

- 选择业务过程
  - 本案例中，管理层希望更好地理解通过 POS 系统获得的客户购买情况。因此需要建模的业务过程是 POS 零售交易，该数据保证商业用户能够分析被销售的产品，它们是在哪几天、在哪个商店、处于何种促销环境中被销售的
- 声明粒度
  - 以最低的原子粒度处理数据。原子数据能够提供最佳的分析灵活性，因为原子数据可以被上卷
  - 在本例中，最细粒度的数据是 POS 交易的单个产品
- 确定维度
  - 粒度选择后，维度的选择就比较直接了。产品和交易事务立即呈现，其他维度如：日期、产品、门店、促销、收银员、支付方式等
- 确定事实
  - 事实必须与粒度吻合。在考虑可能存在的事实时，可能会发现仍然需要调整早期的粒度声明或维度选择
  - POS 系统收集的事实包括销售数量（如，鸡汤面的包数）、单价、折扣、净支付价格、扩展折扣、美元销售额等
    ![零售销售事实表](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/5153f8fb-a160-4801-8aec-1512b2eccd85.png)
  - 4 类事实——销售数量、销售可扩展额、销售、成本额——均是完全可加的
    - 计算获得的事实：如总利润额可以由该事实表行的 2 个事实，扩展销售总额 - 扩展成本总额，计算得到，是否应该将”计算获得的事实“存入数据库。通常推荐将它们物理存储在数据库中，因为这个计算公式是稳定的，存储它可以消除用户计算错误产生的可能性，且能保证所有用户和 BI 报表应用引用总利润额时能够保持一致性。但如果是百分比或比率，则必须由 BI 工具计算，因为此类计算不能被预先计算出来并存储在事实表中
    - 不可加事实：如利润率（需要做除法得出，不能通过事实表同一行的数据计算得到）、单价（不能进行聚合计算）、温度（从其他源系统获得）。如果业务分析师同意，可以将非可加事实存储在事实表中
    - 事务事实表：如本例中的 POS 事务事实表。在设计初期，先估计一下最大的表的情况是很有必要的

## 3.3 维度表设计细节

### 3.3.1 日期维度（注：仅表示日期，不包含当天的所有时间点）

日期维度是一种特殊的维度，几乎出现在所有的维度模型中。日期通常是数据库分区模式下首先需要考虑的维度。
![日期维度表](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/f146640d-59cf-46fb-aeba-f95868d81697.png)
![日期维度表样例](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/11195fa5-87c8-41ab-9ab5-2130cf59ac13.png)

与多数其他维度不同，可以提前建立日期维度表，在表中按行存入 10-20 年的不同日期，也可以包含未来的几年。即使包含 20 年，日期行也仅仅大约有 7300 行，因此是相对较小的维度表。销售案例中的日期维度表设计如下：

日期处理需要日期维度表，而不能通过 SQL 日期类型列处理的原因是：

- 商业用户大多不太熟悉 SQL 日期语义，难以实现典型的日期操作
- SQL 日期函数不支持以属性（工作日与周末、假期、财务周期、季度）进行过滤

这里特别注意几个点：

- 文本属性的标识：属性值应该是有意义的值，如”Holiday/Non-Holiday“而不是”Y/N“、”1/0“、”true/false“等，因为可以对所有用户保持一致，不管是在何种 BI 报表环境或工具中
- 当前与相对日期属性：大多数日期维度属性不应该更新。如果需要有一个属性表示相对滞后日期，如 0 表示今天，-1 表示昨天，+1 表示明天，该属性需要成为计算列由 BI 工具处理，而不是物理存储
- 将当天时间（time-of-day）作为维度或事实：如果到秒的粒度，则 20 年需要 3100 万行，由于日期维度表可能是最常用的维度表，因此应该尽量使其保持较小的容量；如有必要建议上卷到 15 分钟间隔、小时等每个固定周期一行。

### 3.3.2 产品维度

产品维度描述仓库中存储的每个 SKU。尽管典型的仓库可能保存有 60000 个 SKU，但考虑到历史曾经存在过的 SKU，产品维度可能有三百万行以上。
![产品维度表样例](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/208947e0-4fcf-4bd6-afd2-75c1f6bd8a4b.png)

**作为属性或事实的数字值**

有时可能会遇到某些数字，很难判断应该将其归入维度属性分类，还是归入事实分类。经典的例子是产品的价格标准列表。产品价格很显然是一个数字值，因此初始的想法可能是将其当成事实来对待。但是通常标准价格变化缓慢，不像其他事实表中的数量值，对不同的度量事件产生不同的值。

如果某个数字值主要用于计算目的，则它可能应该属于事实表。因为标准价格是非可加的，可用它乘以数量获得扩展总额，这个值是可加的。另外，如果标准价格主要用于价格变化分析，也许变化度量应该被存储在事实表中。如果能预先定义稳定的数字值，用于过滤和分组，则它应该被当成产品维度属性对待。

有时，数字值可同时用于计算以及过滤/分组功能。在此情况下，应当在事实表和维度表中同时存储该值。

基本原则是，涉及计算的数据应该放入事实表，涉及约束、分组和标记的数据应该放入维度表中。

**下钻维度属性**
![下钻维度属性](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/62eceb0a-7c9a-453e-b4d4-d7105818e50c.png)

简单理解，上卷是去掉表格的列头，下钻是增加列头。

### 3.3.3 促销维度

促销维度描述了销售商品的促销条件，促销条件包括临时降价、终端通道展示、报纸广告、礼券等。各种条件是高度关联的，临时降价通常与广告或终端通道展销相关。出于此类原因，在促销维度中为每个发生的促销条件的组合建立一行是具有实际意义的。在过去一年中，有 1000 个广告，5000 个临时降价，1000 个终端通道展销，但仅有 10000 次该三个条件的组合能够影响任何特定的产品。例如，对某次促销，多数门店同时采用上述三种促销机制，但一些商店可能没有布置终端通道展销。在此情况下，需要两个不同的促销条件行，一行包括通常的降价加广告加展示，另外一行包括降价加广告。
![促销维度表](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/c1244e94-25c3-4d1c-bd89-d5e58cae8326.png)

应当仔细权衡包含在促销维度中的促销成本属性。该属性可用于约束和分组。然而，该成本没有出现在表示独立产品销售的 POS 事务事实表中，因为其粒度不符。成本应该驻留在粒度为整个促销的事实表中。

**空外键、空属性和空事实**

通常，许多销售事务包含未被促销的产品。在客户购买未促销产品的记录行里，促销维度列不能是空值，因为外键不能为空，否则违背了参照完整性的要求。

不要在事实表中使用空值键，正确的设计应在对应维度表中包含一行以表明该维度不可用于度量。

一般可以用 -1、Unknown 或 Not Applicable 等值表示在事实表的某行中该维度不可用。

### 3.3.4 事务号码的退化维度

如 POS 事务号码，称为退化维度，简单理解就是没有对应维度表的维度。

## 3.4 实际的销售模式

某商业用户希望理解 2013 年 1 月期间波士顿区通过促销快餐分类的周销售总量。
![实际销售模式](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/c370612a-e04c-4ae9-a755-f48a41de3f78.png)

## 3.5 无事实的事实表

前面的零售模式无法解决一个重要的问题是：处于促销状态但尚未销售的产品包括哪些？

销售事实表所记录的仅仅是实际卖出的 SKU。事实表行中不包括由于没有销售行为而 SKU 为零值的行，因为如果将包含零值的 SKU 都加到事实表中，则事实表将变得无比巨大。

引入无事实的事实表——促销包含事实表，因为它没有度量结果，仅仅获得所包含的键之间的关系。
![无事实的事实表](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/51211644-13da-4758-893a-3cf8f93793b3.png)

为确定当前促销的产品中哪些尚未卖出，需要两步过程：

- 查询促销无事实的事实表，确定给定时间内促销的产品。
- 确定通过 POS 销售事实表哪些产品已经卖出去了。

答案就是上述两个结果列表的差值。

## 3.6 维度与事实表键

### 3.6.1 维度表代理键

维度表的唯一主键应该是代理键而不是来自于操作型系统的标识符，也就是所谓的自然键。代理键简单地以按照顺序序列生成的整数表示。

用代理键的好处是：

- 为数据仓库缓冲操作型系统的变化
- 集成多个源系统：可以从多个缺乏一致性源键的操作型源系统中集成数据
- 改进性能：代理键是尽可能小的一个整数，占空间相比精心设计的自然键要小，构建索引较快
- 处理控制或未知条件：可分配一个代理键区分这些缺乏操作型代码的情况，如 -1
- 支持维度属性变化跟踪：（注：第 5 章详解，尚未看到）

### 3.6.2 维度中自然和持久的超自然键

自然键比如一个人的工号，之前入职分配了一个工号，再次入职又分配了一个新的工号，会存在靠自然键无法准确识别同一个人的情况，因此 ETL 系统需要分配永久的持久性标识符（超自然键）唯一永久标记一个人。

超自然键被当做维度属性处理，它不能作为维度表的代理主键的替换方式（注：详见第 9 章，尚未看到）

### 3.6.3 日期维度的智能键

日期维度有可预测性，因此开源在日期维度中使用更加智能的键，如 YYYYMMDD 格式的整数，在事实表中 YYYYMMDD 的日期代理键对可用性和性能具有决定性的影响。

### 3.6.4 事实表的代理键

在事实表中不一定要使用代理键，如果需要用到的话也可以用自增整数。

## 3.7 抵制规范化的冲动

不推荐使用雪花模型。雪花模型缺点：

- 业务用户不得不理解结构的复杂性。维度建模主要目标之一是简单化
- 查询性能慢
- 并不能有效节约磁盘空间，因为相比事实表的大小，维度表大小不足一提
- 对用户浏览维度的能力有负面影响
  ![雪花模型](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/98957e5e-50ec-4cb1-a089-739423dd467a.png)

不推荐蜈蚣事实表。包含大量维度的蜈蚣事实表，会导致磁盘空间大量占用，多数业务过程可以用不超过 20 个维度的事实表表示，如果某个设计有 25 个或更多维度，应该考虑采用措施合并关联的维度。具有良好关联的属性，如层次级别，以及具有统计相关性的属性，都应该放入一个维度表中。
![蜈蚣模型](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/260d3ce0-900e-4e91-adcd-a15e3a2eeb2a.png)

# 4. 库存

## 4.1 价值链

多数企业都存在关键业务过程的价值链。价值链标明了组织主要活动的自然的、逻辑的流程。
下图描述了销售商价值链的部分子集。
![价值链](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/429905f1-a1d4-410a-a0c1-bfffeb360162.png)

## 4.2 库存模型

### 4.2.1 库存周期快照

零售商希望通过产品和商店分析每天保有商品的库存水平。
再次讨论 4 步骤维度设计过程：

- 业务过程：零售商店库存的周期快照
- 粒度：操作型库存系统提供的原子级别的细节是每家商店中每种产品的日库存。因此粒度是，日期、产品和商店
- 维度：日期、产品和商店
- 事实：当前数量
  ![库存周期快照](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/156c1b68-88d2-418f-8f95-d1b0c3bcc041.png)

库存将产生稠密的快照表，为了避免出现产品脱销的情况，每个产品在每个商店每天都会有一行。

对例子中的零售商来说，有 60000 种产品存储在 100 个商店中，差不多每天新增 600 万行。然而由于行宽仅仅只有 14 个字节，所以每次加载事实表时仅增长 84MB。

某些周期快照的密度需要折中。通常可以接受的是在日级水平保存最后 60 天库存，再之前的保存为周快照。这样在 3 年的周期内就可以由 1095 个快照减少到 208 个总的快照，包含 60 个天快照和 148 个周快照，天快照和周快照存储在两个具有不同周期的事实表中。

**半可加事实**
库存水平对日期来说是非可加的，因为它们表示水平或某一个时间点均衡情况的快照，但对某些维度（产品种类、商店）来说是可加的，因此称为半可加事实。

**不可加事实**
对所有维度来说都是不可加的，称为不可加事实。

**可加事实**
对所有维度来说都是可加的，称为不可加事实。

### 4.2.2 库存事务

建模库存业务过程的第 2 种方式是记录影响库存的每个事务。库存事务可能包括：
接受产品->将产品放入检验区->将产品从检验区提出->若检验存在问题则将产品返回供应商->产品入库->从库中选择产品->包装产品->将产品运送给客户->从客户处接受产品->将客户返回的产品重新入库->从库存中删除产品。
![库存事务](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/0c648f10-625e-4efe-ae6c-1478eebd78f2.png)

**为什么有事务事实表还需要周期快照表呢？**

因为将事务事实表作为分析库存性能的唯一依据是不切实际的，尽管理论上通过回滚所有可能发生的事务到某一已库存位置，重新构建任何时间点的库存情况从理论上是可行的，但实现起来太困难。因为分析问题涉及日期、产品、仓库、供应商等多种因素，因此事务事实表，和周期快照表都有存在的价值。

### 4.2.3 库存累积快照

累积快照事实表用于定义过程开始、结束以及期间的可区分的里程碑。
如本例中，跟踪每一批产品的情况。
![库存累积快照](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/d581eca1-377c-48e7-8af3-8489c860d954.png)
![累积快照演进](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/9b6748b9-7ee3-4538-9ce4-60c0bd19990c.png)

每个累积快照事实表行可重复更新直到某个批次接收的产品从仓库完全耗尽。

## 4.3 事实表类型

事实表主要包括三种基本类型：事务、周期快照、累积快照。这一简单的模型无论在哪个行业都适用，所有三种类型都可以使用，但同时应用三个事实表将会使管理工作非常困难。
![事实表类型](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/a7627abd-6dbd-4ae4-898d-58315ad5ac2a.png)

## 4.4 价值链集成

很多 DW/BI 项目关注从端到端角度考虑问题，以便更好地理解客户行为。显然，实现这一目标需要有从多个过程中一致地浏览客户信息的能力，同样组织希望基于不同的过程，分析他们的产品，或者分析他们的雇员、学生、供应商等等。

从本书第 3 章和第 4 章看到，我们从销售价值链的几个过程建模数据。尽管不同维度模式的不同事实表表示来自每个过程的数据，但模型共享了几个公共业务维度：日期、产品和商店。使用共享公共维度对设计可以被集成的维度模型是至关重要的。
![共享维度](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/f6c772f2-828a-44c7-8dd4-7afbf070a5ef.png)

## 4.5 企业数据仓库总线架构

总线是电力行业的旧词，表示一种常见的连接一切的公共结构，所有事情从总线获取能量。在计算机行业里所指的总线是一种标准接口规范，确保能够插拔磁盘驱动器、DVD 或其他任何数量的专业卡或设备。正是由于计算机的总线标准，使得这些物理设备能够共同工作并有效共存，即使它们由不同的供应商生产制造。

通过为 DW/BI 环境定义标准总线接口，不同组可以在不同时间实现不同的维度模型，如果采用同样的标准，则不同的业务过程主题区域汇集在一起并有效共存。
![共享维度的数据总线](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/2d7eb57a-5613-4787-b7f0-12b5ecc59d2b.png)

总线架构独立于技术和数据库平台。

组织的业务过程表示矩阵行。总线矩阵列表示整个企业的公共维度。
不同企业，总线矩阵行与列的数量会有所变化，对多数企业来说，矩阵非常类似正方形，包含大约 25-50 行，以及大约数量相当的列。在某些行业，如金融行业，列的数量往往比行的数量要多。
核心过程和维度识别完成后，将矩阵中相应处画上“X”表明哪些列与哪一行相关。
![总线矩阵](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/7538e757-b3f2-4624-8dd0-e04703ccc7db.png)

常见总线矩阵错误：

- **基于部门的活包含太多内容的行**：矩阵行不应该对应表示企业组织机构图的各个部门
- **报表为中心或定义过于狭窄的行**：总线矩阵不能类似像针对需求的列表。矩阵行应该对应业务过程，而不是派生的报表或分析
- **过度宽泛的列**：总线矩阵中存在“人”这样的列会导致过分宽泛的对人的定义，如本例要将“人”分为“客户”、“雇员”
- **将层级中的每个级别放入不同的列**：总线矩阵的每个列应该表示最详细的粒度，针对周级别的库存快照之类的需求，不应该建立“日”、“周”、“年”等多个日历层级的矩阵列，而只需要使用单一的日期列。可以在矩阵元素上定义粒度。

## 4.6 一致性维度

一致性维度也称为公共维度、主维度、引用维度和共享维度。就是总线矩阵上的列。

### 4.6.1 多事实表钻取

一致性维度能够确保将来自不同业务过程的性能度量合并到单个报表中。
如下图，可以基于产品描述跨事实表查询数据。
![跨事实表钻取](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/e134579b-4146-4530-9ede-bd09b981bced.png)

### 4.6.2 相同的一致性维度

一致性维度可能存在于不同的维度模型中，如维度在 ETL 系统中建立，然后被同步复制到每个维度模型中，在物理上可能不是同一个表。
不同维度模型中的一致性维度具有相等的行数量、相同的关键词值、相同的属性标识、相同的属性日期定义和相同的属性值。属性列名在多个维度中具有唯一的标识。
如在一个维度中称为“月”，另一个维度中称为月名，则认为维度属性是不一致的；同样，如果某个维度中的一个属性值是“July”，另一个维度中属性值是“JULY”，则称它们是不一致的。

### 4.6.3 总线矩阵的缩减一致性维度

有两种可行的方法用于在矩阵中表示缩减维度。
![缩减一致性维度](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/v1GXn4jNWx8oODQ4/img/e5fbb486-e3b2-47fa-a4ed-f18fbbfd4d79.png)

### 4.6.4 有限一致性

讨论一致性维度的覆盖范围：

- 如果某个集团公司是由业务范围广泛的众多分公司组成，也许没有必要对其开展集成工作
- 如果每个业务线具有特定客户和特定产品，而且没有跨不同行业交叉销售的可能性，则试图从整体上建立一个企业结构就显得毫无意义，因为可能不会存在什么商业价值

可以从最小公共方法开始集成工作，如即使有少数几个属性可以在不同行业保持一致性，仍然是向正确方向迈出了一步。

## 4.7 一致性事实

完成上述的设置一致性维度并与维度模型关联的工作，就完成了数据结构工作的 95%，余下的 5%工作就是建立一致性事实定义。

收入、利润、标准价格和开销、质量度量、客户满意度，以及其他 KPI 是必须保持一致的事实。

在数据命名实践中必须坚守纪律，如果无法完全符合事实，则应该给出不同的命名以做出不同的解释，只有这样，商业用户在计算时才不会合并这些不兼容的事实。
